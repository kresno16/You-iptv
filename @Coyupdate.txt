php
<?php
header('Content-Type: text/plain; charset=utf-8');
header('Cache-Control: no-store, no-cache, must-revalidate, max-age=0');
header('Pragma: no-cache');
header('Expires: 0');
echo "#EXTM3U\n";
date_default_timezone_set('Asia/Jakarta');

const API_HOME='https://api.camel1.live/camel-service/ee/sports_live/home';
const URL_PROG='https://www.camel1.live/match/progressing';
const URL_SCH ='https://www.camel1.live/q/home/schedule';
const PLAY='https://lapakking.com/play/cml/cml.php?id=';
const LOGO_DEF='https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTOky2vDsALsBzmpDKBd3Gd-R14vmUaOC7JWg&usqp=CAU';

const FIX_NAME='EVENT BUSUK KTV MUDAH DI BAJAK';
const GROUP_LIVE='LIVE CAMEL KTV';
const GROUP_SCH ='JADWAL CAMEL KTV';
const UNTIL_TXT='KARYA SC  SKY MEDAN 085361308662 BUSUK';

(function(){
  $must1='KARYA SC  SKY MEDAN 085361308662 BUSUK';
  $must2='EVENT BUSUK KTV MUDAH DI BAJAK';
  if(UNTIL_TXT!==$must1 || FIX_NAME!==$must2) { http_response_code(500); exit; }
  $self=@file_get_contents(__FILE__);
  if($self===false || strpos($self,$must1)===false || strpos($self,$must2)===false){ http_response_code(500); exit; }
})();

function get_raw($u){
  $h=[
    'Accept: text/html,application/json,text/plain,*/*',
    'User-Agent: Mozilla/5.0',
    'Referer: https://www.camel1.live/',
    'Origin: https://www.camel1.live',
    'Cache-Control: no-cache','Pragma: no-cache'
  ];
  $u.=(strpos($u,'?')===false?'?':'&').'_ts='.time().mt_rand(1000,9999);
  $ch=curl_init($u);
  curl_setopt_array($ch,[CURLOPT_RETURNTRANSFER=>1,CURLOPT_FOLLOWLOCATION=>1,CURLOPT_TIMEOUT=>12,CURLOPT_CONNECTTIMEOUT=>4,CURLOPT_HTTPHEADER=>$h,CURLOPT_SSL_VERIFYPEER=>0,CURLOPT_SSL_VERIFYHOST=>0,CURLOPT_ENCODING=>'']);
  $r=curl_exec($ch); curl_close($ch);
  return $r?:'';
}
function get_json_any($u){
  $r=get_raw($u);
  if($r==='') return null;
  $j=json_decode($r,true);
  if(is_array($j)) return $j;
  if(preg_match('/<script[^>]+id="__NEXT_DATA__"[^>]*>(.*?)<\/script>/is',$r,$m)){
    $j=json_decode(html_entity_decode($m[1],ENT_QUOTES),true);
    if(is_array($j)) return $j;
  }
  if(preg_match_all('/<script[^>]*type="application\/json"[^>]*>(.*?)<\/script>/is',$r,$mm)){
    foreach($mm[1] as $b){
      $j=json_decode(html_entity_decode($b,ENT_QUOTES),true);
      if(is_array($j)) return $j;
    }
  }
  return null;
}
function ts($x){
  if($x===null||$x==='') return null;
  if(is_numeric($x)){ $n=(int)$x; return $n>2000000000?(int)($n/1000):$n; }
  $t=strtotime((string)$x); return $t?:null;
}
function s($a,$ks){
  if(!is_array($a)) return '';
  foreach($ks as $k){
    if(!array_key_exists($k,$a)) continue;
    $v=$a[$k];
    if($v===null||$v==='') continue;
    if(is_string($v)||is_numeric($v)) return trim((string)$v);
    if(is_array($v)) foreach($v as $x) if(is_string($x)||is_numeric($x)) return trim((string)$x);
  }
  return '';
}
function img($u){
  if(!is_string($u)) return false;
  $u=trim($u);
  return $u!=='' && stripos($u,'http')===0 && (preg_match('/\.(png|jpg|jpeg|webp|gif|svg)(\?|#|$)/i',$u)||stripos($u,'image')!==false);
}
function logo($n,$d){
  if($d<=0) return '';
  if(is_string($n)) return img($n)?trim($n):'';
  if(!is_array($n)) return '';
  foreach(['homeLogo','awayLogo','teamLogo','logo','icon','img','image','cover','poster','banner','thumb','thumbnail','avatar','emblem','badge','flag'] as $k)
    if(isset($n[$k])){ $r=logo($n[$k],$d-1); if($r!=='') return $r; }
  foreach($n as $v){ $r=logo($v,$d-1); if($r!=='') return $r; }
  return '';
}
function find_id($n){
  if(!is_array($n)) return '';
  $id=s($n,['id']); if($id!=='' && preg_match('/^[a-z0-9]{10,40}$/i',$id)) return $id;
  $id=s($n,['matchId','match_id','mid','roomId','room_id','liveId','live_id','eventId','event_id','anchorId','anchor_id','streamId','stream_id','channelId','channel_id','programId','program_id']);
  if($id!=='' && preg_match('/^[a-z0-9\-_]{6,80}$/i',$id)) return $id;
  foreach(['match','event','data','detail','info','base'] as $k)
    if(isset($n[$k])&&is_array($n[$k])){ $x=find_id($n[$k]); if($x!=='') return $x; }
  return '';
}
function is_live_node($n){
  $st=strtolower(s($n,['status','state','liveStatus','streamStatus','matchStatus','isLive','is_living','living_status']));
  if($st!=='' && preg_match('/live|running|playing|ongoing|in\s*progress|onair|true|1/',$st)) return true;
  $t=strtolower(s($n,['title','name','matchTitle','eventTitle','programTitle','roomTitle','channelTitle']));
  if($t!=='' && preg_match('/\blive\b|sedang\s*berlangsung|ongoing|in\s*progress/',$t)) return true;
  $now=time();
  $start=ts(s($n,['startTime','start_time','startAt','start_at','beginTime','begin_time','kickoff','start','matchTime','match_time','startTs','start_ts','startTimestamp','start_timestamp','scheduleTime','schedule_time','plannedStart','planned_start','time','date']));
  $end  =ts(s($n,['endTime','end_time','endAt','end_at','finishTime','finish_time','stopTime','stop_time','end','endTs','end_ts','endTimestamp','end_timestamp','plannedEnd','planned_end','end_date']));
  if($start && $now >= $start && (!$end || $now <= $end + 7200)) return true;
  return false;
}
function collect($n,&$out,$src,$depth){
  if($depth<=0||!is_array($n)) return;
  $id=find_id($n);
  if($id!==''){
    $st=ts(s($n,['startTime','start_time','startAt','start_at','beginTime','begin_time','kickoff','start','matchTime','match_time','startTs','start_ts','startTimestamp','start_timestamp','scheduleTime','schedule_time','plannedStart','planned_start','time','date']));
    $en=ts(s($n,['endTime','end_time','endAt','end_at','finishTime','finish_time','stopTime','stop_time','end','endTs','end_ts','endTimestamp','end_timestamp','plannedEnd','planned_end','end_date']));
    $lg='';
    if(isset($n['home'])&&is_array($n['home'])) $lg=logo($n['home'],4);
    if($lg===''&&isset($n['homeTeam'])&&is_array($n['homeTeam'])) $lg=logo($n['homeTeam'],4);
    if($lg===''&&isset($n['away'])&&is_array($n['away'])) $lg=logo($n['away'],4);
    if($lg===''&&isset($n['awayTeam'])&&is_array($n['awayTeam'])) $lg=logo($n['awayTeam'],4);
    if($lg==='') $lg=logo($n,6);
    if($lg==='') $lg=LOGO_DEF;

    $group=is_live_node($n)?GROUP_LIVE:GROUP_SCH;
    $out[$src.'|'.$id]=[$id,$st,$en,$lg,$group];
  }
  foreach($n as $v) if(is_array($v)) collect($v,$out,$src,$depth-1);
}
function fmt($st,$en,$t){
  if($st){
    $a=date('H.i',$st).' wib';
    if($en && $en>=$st) return $a.' sampai '.date('H.i',$en).' wib '.$t;
    return $a.' '.UNTIL_TXT.' '.$t;
  }
  return $t;
}

$out=[];
$j=get_json_any(API_HOME); if(is_array($j)) collect($j,$out,'HOME',14);
$j=get_json_any(URL_PROG); if(is_array($j)) collect($j,$out,'PROG',14);
$j=get_json_any(URL_SCH ); if(is_array($j)) collect($j,$out,'SCH', 14);

if(!$out){ echo "#INFO kosong\n"; exit; }

$rows=array_values($out);
usort($rows,function($x,$y){
  $ga=$x[4]===GROUP_LIVE?0:1; $gb=$y[4]===GROUP_LIVE?0:1;
  if($ga!=$gb) return $ga<$gb?-1:1;
  $a=$x[1]?:9999999999; $b=$y[1]?:9999999999;
  if($a==$b) return 0; return $a<$b?-1:1;
});

foreach($rows as $r){
  $id=$r[0]; $t=fmt($r[1],$r[2],FIX_NAME); $lg=$r[3]; $grp=$r[4];
  echo '#EXTINF:-1 tvg-logo="'.$lg.'" group-title="'.$grp.'", '.$t."\n".PLAY.urlencode($id)."\n";
}
?>
